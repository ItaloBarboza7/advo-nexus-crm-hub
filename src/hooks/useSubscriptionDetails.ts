
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";

interface SubscriptionDetails {
  plan: string;
  amount: number;
  cardBrand: string;
  cardLast4: string;
  cardExp: string;
  status: string;
  isLoading: boolean;
  error?: string;
  subscriptionId?: string;
}

export function useSubscriptionDetails() {
  const [details, setDetails] = useState<SubscriptionDetails>({
    plan: "",
    amount: 0,
    cardBrand: "",
    cardLast4: "",
    cardExp: "",
    status: "",
    isLoading: true,
  });

  useEffect(() => {
    getSubDetails();
    // eslint-disable-next-line
  }, []);

  async function getSubDetails() {
    setDetails(d => ({ ...d, isLoading: true, error: undefined }));

    try {
      console.log("üí≥ useSubscriptionDetails - Iniciando busca de detalhes da assinatura...");
      
      // Verificar se o usu√°rio est√° autenticado
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (authError) {
        console.error("‚ùå Erro de autentica√ß√£o:", authError);
        setDetails(d => ({ 
          ...d, 
          isLoading: false, 
          error: "Erro de autentica√ß√£o. Fa√ßa login novamente." 
        }));
        return;
      }

      if (!user) {
        console.log("üë§ Usu√°rio n√£o autenticado");
        setDetails(d => ({ 
          ...d, 
          isLoading: false, 
          error: "Usu√°rio n√£o autenticado" 
        }));
        return;
      }

      console.log("üë§ Usu√°rio autenticado:", user.email);

      // Nova fun√ß√£o edge chamada 'get-stripe-details'
      const { data, error } = await supabase.functions.invoke('get-stripe-details');
      
      console.log("üìä Resposta da fun√ß√£o get-stripe-details:", { data, error });
      
      if (error) {
        console.error("‚ùå Erro ao buscar detalhes do Stripe:", error);
        
        // Para novos usu√°rios que ainda n√£o t√™m assinatura, n√£o mostrar erro
        if (error.message?.includes('No customer found') || 
            error.message?.includes('Customer not found') ||
            error.message?.includes('No subscription found')) {
          console.log("üìù Novo usu√°rio sem assinatura ativa, usando valores padr√£o");
          setDetails({
            plan: "Nenhum plano ativo",
            amount: 0,
            cardBrand: "",
            cardLast4: "",
            cardExp: "",
            status: "inactive",
            isLoading: false,
            error: undefined
          });
          return;
        }
        
        setDetails(d => ({ 
          ...d, 
          isLoading: false, 
          error: `Erro ao carregar dados da assinatura: ${error.message}` 
        }));
        return;
      }

      if (!data || typeof data !== 'object') {
        console.log("üìù Dados de assinatura n√£o encontrados, usu√°rio sem plano ativo");
        setDetails({
          plan: "Nenhum plano ativo",
          amount: 0,
          cardBrand: "",
          cardLast4: "",
          cardExp: "",
          status: "inactive",
          isLoading: false,
          error: undefined
        });
        return;
      }

      console.log("‚úÖ Detalhes da assinatura carregados com sucesso:", data);
      
      setDetails({
        plan: data.plan_name || "Plano n√£o identificado",
        amount: data.amount || 0,
        cardBrand: data.card_brand || "",
        cardLast4: data.card_last4 || "",
        cardExp: data.exp_month && data.exp_year ? `${data.exp_month}/${data.exp_year}` : "",
        status: data.status || "unknown",
        isLoading: false,
        subscriptionId: data.subscription_id,
        error: undefined
      });
      
    } catch (error) {
      console.error("‚ùå Erro inesperado ao buscar detalhes da assinatura:", error);
      
      // Para novos usu√°rios, isso pode ser normal
      setDetails({
        plan: "Nenhum plano ativo",
        amount: 0,
        cardBrand: "",
        cardLast4: "",
        cardExp: "",
        status: "inactive",
        isLoading: false,
        error: undefined // N√£o mostrar erro para novos usu√°rios
      });
    }
  }

  return details;
}
